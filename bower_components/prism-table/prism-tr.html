<link rel="import" href="../polymer/polymer.html" />
<link rel="import" href="prism-table-checkbox.html" />

<dom-module id="prism-tr">
    <template>
        <style>
             :host {
                display: table-row;
                -webkit-transition: all 0.3s ease;
                -o-transition: all 0.3s ease;
                transition: all 0.3s ease;
            }


             ::slotted(:not(prism-td):not(prism-th)) {
                display: none;
            }

            @media screen and (max-width: 768px) {
                 :host {
                    display: var(--prism-table-row-display);
                    border: var(--prism-table-row-border);
                    margin-bottom: var(--prism-table-row-margin-bottom);

                    -webkit-box-shadow: var(--prism-table-row-shadow);
                    -moz-box-shadow: var(--prism-table-row-shadow);
                    box-shadow: var(--prism-table-row-shadow);
                }

                 ::slotted(prism-td:last-child) {
                    /* [Chrome] */
                    border-bottom: var(--prism-table-cell-last-border-bottom);
                }
                 ::slotted(prism-td):last-child {
                    /* [Firefox] */
                    border-bottom: var(--prism-table-cell-last-border-bottom);
                }

                 :host(:hover) {
                    --prism-table-body-cell-stripe-background-color: transparent;
                }

                 :host(.selected) {
                    --prism-table-body-cell-stripe-background-color: transparent;
                }

                 ::slotted(prism-td:nth-child(odd):not(.selected):not(:hover)) {
                    /* [Chrome] */
                    color: var(--prism-table-body-cell-stripe-color);
                    background-color: var(--prism-table-body-cell-stripe-background-color);
                }

                 ::slotted(prism-td):nth-child(odd):not(.selected):not(:hover) {
                    /* [Firefox] */
                    color: var(--prism-table-body-cell-stripe-color);
                    background-color: var(--prism-table-body-cell-stripe-background-color);
                }
            }
        </style>
        <slot></slot>
    </template>
    <script>
        'use strict';

        /**
         * Row of `<prism-table>`
         *
         * @memberof Prhythm
         * @element prism-tr
         * @customElement
         * @polymer
         */
        class PrismTableRow extends Polymer.Element {

            static get is() {
                return 'prism-tr'
            }

            static get properties() {
                return {
                    /**
                     * `<prism-table-selector>` of this row
                     *
                     * @type {HtmlElement}
                     */
                    selectorElement: Object,

                    /**
                     * `<prism-table>` of this row
                     *
                     * @type {HtmlElement}
                     */
                    tableElement: Object,

                    /**
                     * `<prism-table-checkbox>` of this row
                     *
                     * @type {HtmlElement}
                     */
                    checkboxElement: Object,

                    /**
                     * True if row is not in header or footer
                     */
                    dataRow: {
                        type: Boolean,
                        computed: '_computedDataRow(selectorElement)'
                    }
                }
            }

            connectedCallback() {
                super.connectedCallback();

                // Find components `<prism-table>` and `<prism-table-selector>` of this row
                this._findSelectorElement();
                let selector = this.get('selectorElement');

                if (selector) {
                    // Register click event handler
                    this.addEventListener('click', e => this._toggleClick(e));

                    // [Append checkbox element]
                    // Due to lifecycle of data loading, checkbox element will be generated by <prism-data-table>,
                    // otherwise checkbox element is automatically generated if below is fit:
                    // 1. Multiple and allow-checkbox is set
                    // 2. First columns is rendered
                    this.updateCheckbox(selector);
                }
            }

            /**
             * True when current row is body row
             *
             * @param {HtmlElement} selector Element of `<prism-table-selector>`
             * @return {Boolean} 
             */
            _computedDataRow(selector) {
                let parent = this.parentElement || {};
                return parent.tagName === 'PRISM-TABLE'
                    || parent.tagName === 'PRISM-TBODY';
            }

            /**
             * Toggle row event handler
             *
             * @param {Event} e Event argument
             * @return {Void}
             */
            _toggleClick(e) {
                // Stop bubble
                e.stopPropagation();
                // Only work for body rows
                if (!this.dataRow) return;

                let selector = this.selectorElement;
                // Disable selection from <prism-data-table> if disableSelector is set
                if (selector.disabled) return;

                // Get row selection value
                let colIndex = selector.columnIndexForSelected || -1;
                let attrName = selector.attributeForSelected || 'key';
                let value = this._getSelectedValue(colIndex, attrName);

                if (value === null || value === undefined) {
                    console.error(`<prism-table-selecot> select null or undefined value on column index: ${colIndex}, attribute name: ${attrName}`);
                } else {
                    // Works only when selection value is defined
                    if (selector.multiple) {  // Multiple selection
                        // Update selected value
                        selector.toggleSelected(value);
                    } else {  // single selection
                        // Update selected value
                        if (selector.isSelected(value)) {
                            // Clear all selected
                            selector.clearSelected();
                        } else {
                            // Update selected value
                            selector.changeSelected([value]);
                        }
                    }
                }
            }

            /**
             * Update checkbox render
             *
             * @param {HtmlElement} selector Element of `<prism-table-selector>`
             * @return {Void}
             */
            updateCheckbox(selector) {
                // Do nothing when there is no cell rendered
                let firstCell = Array.prototype.find.call(this.children, (child) => child.tagName === 'PRISM-TH' || child.tagName === 'PRISM-TD');
                if (!firstCell) return;

                if (selector.multiple && selector.allowCheckbox) {
                    if (!this._getCheckbox()) {
                        let cell;
                        if (this.dataRow) {
                            // Insert checkbox at first cell
                            cell = firstCell.cloneNode(false);
                            cell.setAttribute('title', 'Selection');
                            let checkbox = document.createElement('prism-table-checkbox');
                            cell.appendChild(checkbox);
                            this.set('checkboxElement', checkbox);
                        } else {
                            // Insert checkbox header cell
                            cell = firstCell.cloneNode(false);
                            cell.classList.add('selection-header');
                            cell.appendChild(document.createTextNode('\u00A0'));
                        }
                        this.insertBefore(cell, this.childNodes[0]);
                    }
                } else {
                    // Remove existing checkbox
                    let checkbox = this._getCheckbox();
                    if (this.dataRow && checkbox) {
                        this.removeChild(checkbox.parentElement);
                        this.set('checkboxElement', null);
                    }
                    // Remove checkbox header cell
                    if (!this.dataRow && this.querySelector('.selection-header')) {
                        this.removeChild(this.querySelector('.selection-header'));
                    }
                }

                // Update row style
                this.updateSelected(selector.selectedItems, selector);;
            }

            /**
             * Update row style via selected values
             *
             * @param {Array} values A set of current selection
             * @param {HtmlElement} selector Element of `<prism-table-selector>`
             * @return {Void}
             */
            updateSelected(values, selector) {
                if (!this.dataRow) return;

                // Get row selection value
                let colIndex = selector.columnIndexForSelected || -1;
                let attrName = selector.attributeForSelected || 'key';
                let value = this._getSelectedValue(colIndex, attrName);

                // Check row is if selected
                let selected = (values || []).find((item) => {
                    return selector.balanced(item, value);
                });

                if (selected === undefined) {  // Row is not selected
                    if (selector.multiple) {  // Multiple selection
                        // Update selection of checkbox
                        if (selector.allowCheckbox) {
                            let checkbox = this._getCheckbox();
                            if (checkbox) checkbox.check(false);
                        } else {
                            this.classList.remove('selected');
                        }
                    } else {  // Single selection
                        // Update row style
                        this.classList.remove('selected');
                    }
                } else {  // Row is selected
                    if (selector.multiple) {  // Multiple selection
                        // Update selection of checkbox
                        if (selector.allowCheckbox) {
                            let checkbox = this._getCheckbox();
                            if (checkbox) {
                                checkbox.check(true);
                            }
                        } else {
                            this.classList.add('selected');
                        }
                    } else {  // Single selection
                        // Update row style
                        this.classList.add('selected');
                    }
                }
            }

            /**
             * Get checkbox element in row if exists
             *
             * @return {HtmlElement}
             */
            _getCheckbox() {
                if (this.checkboxElement) {
                    return this.checkboxElement;
                } else {
                    let cell = this.children[0] || {};
                    let element = cell.firstElementChild || {};
                    if (element.tagName === 'PRISM-TABLE-CHECKBOX') {
                        this.set('checkboxElement', element);
                        return element;
                    } else {
                        return null;
                    }
                }
            }

            /**
             * Get value from specific attribute
             *
             * @param {Number} colIndex Column index
             * @param {String} attrName Name of attribute in row or column
             * @return {*}
             */
            _getSelectedValue(colIndex, attrName) {
                if (colIndex < 0) {
                    // Pick attribute value of row if column index is negative
                    return this.get(attrName) || this[attrName] || this.getAttribute(attrName);
                } else {
                    // Pick attribute value of cell （<prism-th>/<prism-td>） if column index is positive
                    if (colIndex < this.children.length) {
                        let cell = this.children[colIndex];
                        return cell[attrName] || this.getAttribute(attrName);
                    } else {
                        console.error(`<prism-table-selecot> select null or undefined value on column index: ${colIndex}, attribute name: ${attrName}`);
                        return undefined;
                    }
                }
            }

            /**
             * Find components of `<prism-table>` and `<prism-table-selector>`
             *
             * @return {Void}
             */
            _findSelectorElement() {
                let count = 3;
                let element = this;

                while (count-- > 0 && element) {
                    element = element.parentElement;
                    if (element && element.tagName === 'PRISM-TABLE') {
                        this.set('tableElement', element);
                        continue;
                    }
                    if (element && element.tagName === 'PRISM-TABLE-SELECTOR') {
                        this.set('selectorElement', element);
                    }
                }
            }

        }

        customElements.define(PrismTableRow.is, PrismTableRow);
    </script>
</dom-module>